// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OPERATOR
}

enum StatusUser {
  ACTIVE
  INACTIVE
}

enum NoType {
  NUMERIC
  ALPHANUMERIC
  CUSTOM
}

enum UniqueConstraintType {
  NONE
  NO
  NO_TANGGAL
  NO_NOFISIK
}

model User {
  id                         Int                          @id @default(autoincrement())
  name                       String
  email                      String                       @unique
  username                   String                       @unique
  password                   String
  role                       Role                         @default(OPERATOR)
  statusUser                 StatusUser                   @default(ACTIVE)
  refreshToken               String?
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  AktaKematian               AktaKematian[]
  AktaKelahiran              AktaKelahiran[]
  SuratKehilangan            SuratKehilangan[]
  SuratPermohonanPindah      SuratPermohonanPindah[]
  SuratPerubahanKependudukan SuratPerubahanKependudukan[]
  arsipFiles                 ArsipFile[]
  arsipSemua                 ArsipSemua[]
}

model Kategori {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  slug        String  @unique
  description String?

  formNo           String
  rulesFormNo      Boolean
  rulesFormNama    Boolean
  rulesFormTanggal Boolean
  maxFile          Int

  // Dynamic Validation Rules
  noType      NoType  @default(ALPHANUMERIC)
  noMinLength Int?
  noMaxLength Int?
  noRegex     String?
  noPrefix    String?
  noFormat    String?
  noMask      String?

  uniqueConstraint UniqueConstraintType @default(NONE)
  isEncrypt        Boolean              @default(false)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  arsipSemuas ArsipSemua[]
}

model ArsipSemua {
  id          Int         @id @default(autoincrement())
  idKategori  Int
  kategori    Kategori    @relation(fields: [idKategori], references: [id], onDelete: Cascade)
  no          String
  noEnc       String?
  noHash      String?
  nama        String?
  tanggal     DateTime?
  noFisik     String
  createdById Int?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
  arsipFiles  ArsipFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([idKategori])
  @@index([idKategori, no])
  @@index([idKategori, no, tanggal])
  @@index([idKategori, no, noFisik])
}

model ArsipFile {
  id              Int                         @id @default(autoincrement())
  originalName    String
  path            String
  aktaKematianId  Int?
  aktaKematian    AktaKematian?               @relation(fields: [aktaKematianId], references: [id], onDelete: Cascade)
  aktaKelahiranId Int?
  aktaKelahiran   AktaKelahiran?              @relation(fields: [aktaKelahiranId], references: [id], onDelete: Cascade)
  suratPerPinId   Int?
  suratPerPin     SuratPermohonanPindah?      @relation(fields: [suratPerPinId], references: [id], onDelete: Cascade)
  suratPerKpnId   Int?
  suratPerKpn     SuratPerubahanKependudukan? @relation(fields: [suratPerKpnId], references: [id], onDelete: Cascade)
  uploadById      Int?
  uploadBy        User?                       @relation(fields: [uploadById], references: [id], onDelete: SetNull)
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  arsipSemua      ArsipSemua?                 @relation(fields: [arsipSemuaId], references: [id], onDelete: Cascade)
  arsipSemuaId    Int?
}

model AktaKematian {
  id          Int         @id @default(autoincrement())
  noAkta      String      @unique
  noAktaEnc   String?
  noAktaHash  String?     @unique
  noFisik     String
  createdById Int?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  arsipFiles  ArsipFile[]

  @@index([createdAt])
  @@index([createdById])
}

model AktaKelahiran {
  id          Int         @id @default(autoincrement())
  noAkta      String      @unique
  noAktaEnc   String?
  noAktaHash  String?     @unique
  noFisik     String
  createdById Int?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  arsipFiles  ArsipFile[]

  @@index([createdAt])
  @@index([createdById])
}

model SuratKehilangan {
  id          Int      @id @default(autoincrement())
  nik         String
  nikEnc      String?
  nikHash     String?
  tanggal     DateTime @db.Date
  noFisik     String
  files       String
  createdById Int?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([nik, tanggal])
  @@index([createdAt])
  @@index([createdById])
}

model SuratPermohonanPindah {
  id          Int         @id @default(autoincrement())
  nik         String
  nikEnc      String?
  nikHash     String?     @unique
  noFisik     String
  createdById Int?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  arsipFiles  ArsipFile[]

  @@index([createdAt])
  @@index([createdById])
}

model SuratPerubahanKependudukan {
  id          Int         @id @default(autoincrement())
  nik         String
  nikEnc      String?
  nikHash     String?     @unique
  noFisik     String
  createdById Int?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  arsipFiles  ArsipFile[]

  @@index([createdAt])
  @@index([createdById])
}
